{"version":3,"names":["useEffect","useMemo","Platform","Rea","useVideoLoading","currentSKImageFrames","copyFrameOnAndroid","currentFrame","OS","tex","value","makeNonTextureImage","dispose","setFrame","video","console","log","img","nextImage","defaultOptions","looping","paused","seek","currentTime","volume","useOption","defaultValue","useSharedValue","isSharedValue","disposeVideo","useVideo","source","userOptions","_userOptions$paused","_userOptions$looping","_userOptions$seek","_userOptions$volume","isPaused","lastTimestamp","duration","_video$duration","framerate","_video$framerate","size","_video$size","width","height","rotation","_video$rotation","frameDuration","currentFrameDuration","Math","floor","useAnimatedReaction","pause","play","setVolume","useFrameCallback","frameInfo","currentTimestamp","timestamp","delta","isOver","runOnUI"],"sources":["useVideo.ts"],"sourcesContent":["import type { SharedValue, FrameInfo } from \"react-native-reanimated\";\nimport { useEffect, useMemo } from \"react\";\n\nimport type { SkImage, Video } from \"@shopify/react-native-skia\";\nimport { Platform } from \"@shopify/react-native-skia/src/Platform/Platform\";\n\nimport Rea from \"@shopify/react-native-skia/src/external/reanimated/ReanimatedProxy\";\nimport { useVideoLoading } from \"@shopify/react-native-skia/src/external/reanimated/useVideoLoading\";\n\ntype Animated<T> = SharedValue<T> | T;\n\ninterface PlaybackOptions {\n  looping: Animated<boolean>;\n  paused: Animated<boolean>;\n  seek: Animated<number | null>;\n  volume: Animated<number>;\n}\n\nexport const currentSKImageFrames: SkImage[] = [];\n\nconst copyFrameOnAndroid = (currentFrame: SharedValue<SkImage | null>) => {\n  \"worklet\";\n  // on android we need to copy the texture before it's invalidated\n  if (Platform.OS === \"android\" || Platform.OS === \"harmony\") {\n    const tex = currentFrame.value;\n    if (tex) {\n      currentFrame.value = tex.makeNonTextureImage();\n      //currentSKImageFrames.push(currentFrame.value);\n      //console.log(\"push OK\");\n      tex.dispose();\n    }\n  }\n};\n\nconst setFrame = (video: Video, currentFrame: SharedValue<SkImage | null>) => {\n  \"worklet\";\n  console.log(\"nextImage\");\n  const img = video.nextImage();\n  if (img) {\n    if (currentFrame.value) {\n      currentFrame.value.dispose();\n    }\n    currentFrame.value = img;\n    copyFrameOnAndroid(currentFrame);\n  }\n};\n\nconst defaultOptions = {\n  looping: true,\n  paused: false,\n  seek: null,\n  currentTime: 0,\n  volume: 0,\n};\n\nconst useOption = <T>(value: Animated<T>) => {\n  \"worklet\";\n  // TODO: only create defaultValue is needed (via makeMutable)\n  const defaultValue = Rea.useSharedValue(\n    Rea.isSharedValue(value) ? value.value : value\n  );\n  return Rea.isSharedValue(value) ? value : defaultValue;\n};\n\nconst disposeVideo = (video: Video | null) => {\n  \"worklet\";\n\n  video?.dispose();\n};\n\nexport const useVideo = (\n  source: string | null,\n  userOptions?: Partial<PlaybackOptions>\n) => {\n  const video = useVideoLoading(source);\n  const isPaused = useOption(userOptions?.paused ?? defaultOptions.paused);\n  const looping = useOption(userOptions?.looping ?? defaultOptions.looping);\n  const seek = useOption(userOptions?.seek ?? defaultOptions.seek);\n  const volume = useOption(userOptions?.volume ?? defaultOptions.volume);\n  const currentFrame = Rea.useSharedValue<null | SkImage>(null);\n  const currentTime = Rea.useSharedValue(0);\n  const lastTimestamp = Rea.useSharedValue(-1);\n  const duration = useMemo(() => video?.duration() ?? 0, [video]);\n  const framerate = useMemo(\n    () => (Platform.OS === \"web\" ? -1 : video?.framerate() ?? 0),\n    [video]\n  );\n  const size = useMemo(() => video?.size() ?? { width: 0, height: 0 }, [video]);\n  const rotation = useMemo(() => video?.rotation() ?? 0, [video]);\n  const frameDuration = 1000 / framerate;\n  const currentFrameDuration = Math.floor(frameDuration);\n  Rea.useAnimatedReaction(\n    () => isPaused.value,\n    (paused) => {\n      if (paused) {\n        video?.pause();\n      } else {\n        lastTimestamp.value = -1;\n        video?.play();\n      }\n    }\n  );\n  Rea.useAnimatedReaction(\n    () => seek.value,\n    (value) => {\n      if (value !== null) {\n        video?.seek(value);\n        currentTime.value = value;\n        seek.value = null;\n      }\n    }\n  );\n  Rea.useAnimatedReaction(\n    () => volume.value,\n    (value) => {\n      video?.setVolume(value);\n    }\n  );\n\n  Rea.useFrameCallback(async (frameInfo: FrameInfo) => {\n    \"worklet\";\n    if (!video) {\n      return;\n    }\n    if (isPaused.value) {\n      return;\n    }\n    const currentTimestamp = frameInfo.timestamp;\n    if (lastTimestamp.value === -1) {\n      lastTimestamp.value = currentTimestamp;\n    }\n    const delta = currentTimestamp - lastTimestamp.value;\n    const isOver = currentTime.value + delta > duration;\n\n    if (isOver && looping.value) {\n      console.log(\"in if seek\");\n      seek.value = 0;\n      currentTime.value = seek.value;\n      lastTimestamp.value = currentTimestamp;\n    }\n    // On Web the framerate is uknown.\n    // This could be optimized by using requestVideoFrameCallback (Chrome only)\n\n    if (\n      (delta > currentFrameDuration * 3 && !isOver) ||\n      Platform.OS === \"web\"\n    ) {\n      //console.log(`当前时间:${currentTime.value},时间间隔:${delta},当前帧持续时间:${currentFrameDuration}`)\n      setFrame(video, currentFrame);\n      currentTime.value += delta;\n      lastTimestamp.value = currentTimestamp;\n    }\n  });\n\n  useEffect(() => {\n    return () => {\n      // TODO: should video simply be a shared value instead?\n      Rea.runOnUI(disposeVideo)(video);\n    };\n  }, [video]);\n\n  return {\n    currentFrame,\n    currentTime,\n    duration,\n    framerate,\n    rotation,\n    size,\n  };\n};\n"],"mappings":"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","ignoreList":[]}
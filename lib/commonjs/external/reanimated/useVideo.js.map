{"version":3,"names":["_react","require","_Platform","_ReanimatedProxy","_interopRequireDefault","_useVideoLoading","e","__esModule","default","currentSKImageFrames","exports","copyFrameOnAndroid","currentFrame","Platform","OS","tex","value","makeNonTextureImage","dispose","setFrame","video","console","log","img","nextImage","defaultOptions","looping","paused","seek","currentTime","volume","useOption","defaultValue","Rea","useSharedValue","isSharedValue","disposeVideo","useVideo","source","userOptions","_userOptions$paused","_userOptions$looping","_userOptions$seek","_userOptions$volume","useVideoLoading","isPaused","lastTimestamp","duration","useMemo","_video$duration","framerate","_video$framerate","size","_video$size","width","height","rotation","_video$rotation","frameDuration","currentFrameDuration","Math","floor","useAnimatedReaction","pause","play","setVolume","useFrameCallback","frameInfo","currentTimestamp","timestamp","delta","isOver","useEffect","runOnUI"],"sources":["useVideo.ts"],"sourcesContent":["import type { SharedValue, FrameInfo } from \"react-native-reanimated\";\nimport { useEffect, useMemo } from \"react\";\n\nimport type { SkImage, Video } from \"@shopify/react-native-skia\";\nimport { Platform } from \"@shopify/react-native-skia/src/Platform/Platform\";\n\nimport Rea from \"@shopify/react-native-skia/src/external/reanimated/ReanimatedProxy\";\nimport { useVideoLoading } from \"@shopify/react-native-skia/src/external/reanimated/useVideoLoading\";\n\ntype Animated<T> = SharedValue<T> | T;\n\ninterface PlaybackOptions {\n  looping: Animated<boolean>;\n  paused: Animated<boolean>;\n  seek: Animated<number | null>;\n  volume: Animated<number>;\n}\n\nexport const currentSKImageFrames: SkImage[] = [];\n\nconst copyFrameOnAndroid = (currentFrame: SharedValue<SkImage | null>) => {\n  \"worklet\";\n  // on android we need to copy the texture before it's invalidated\n  if (Platform.OS === \"android\" || Platform.OS === \"harmony\") {\n    const tex = currentFrame.value;\n    if (tex) {\n      currentFrame.value = tex.makeNonTextureImage();\n      //currentSKImageFrames.push(currentFrame.value);\n      //console.log(\"push OK\");\n      tex.dispose();\n    }\n  }\n};\n\nconst setFrame = (video: Video, currentFrame: SharedValue<SkImage | null>) => {\n  \"worklet\";\n  console.log(\"nextImage\");\n  const img = video.nextImage();\n  if (img) {\n    if (currentFrame.value) {\n      currentFrame.value.dispose();\n    }\n    currentFrame.value = img;\n    copyFrameOnAndroid(currentFrame);\n  }\n};\n\nconst defaultOptions = {\n  looping: true,\n  paused: false,\n  seek: null,\n  currentTime: 0,\n  volume: 0,\n};\n\nconst useOption = <T>(value: Animated<T>) => {\n  \"worklet\";\n  // TODO: only create defaultValue is needed (via makeMutable)\n  const defaultValue = Rea.useSharedValue(\n    Rea.isSharedValue(value) ? value.value : value\n  );\n  return Rea.isSharedValue(value) ? value : defaultValue;\n};\n\nconst disposeVideo = (video: Video | null) => {\n  \"worklet\";\n\n  video?.dispose();\n};\n\nexport const useVideo = (\n  source: string | null,\n  userOptions?: Partial<PlaybackOptions>\n) => {\n  const video = useVideoLoading(source);\n  const isPaused = useOption(userOptions?.paused ?? defaultOptions.paused);\n  const looping = useOption(userOptions?.looping ?? defaultOptions.looping);\n  const seek = useOption(userOptions?.seek ?? defaultOptions.seek);\n  const volume = useOption(userOptions?.volume ?? defaultOptions.volume);\n  const currentFrame = Rea.useSharedValue<null | SkImage>(null);\n  const currentTime = Rea.useSharedValue(0);\n  const lastTimestamp = Rea.useSharedValue(-1);\n  const duration = useMemo(() => video?.duration() ?? 0, [video]);\n  const framerate = useMemo(\n    () => (Platform.OS === \"web\" ? -1 : video?.framerate() ?? 0),\n    [video]\n  );\n  const size = useMemo(() => video?.size() ?? { width: 0, height: 0 }, [video]);\n  const rotation = useMemo(() => video?.rotation() ?? 0, [video]);\n  const frameDuration = 1000 / framerate;\n  const currentFrameDuration = Math.floor(frameDuration);\n  Rea.useAnimatedReaction(\n    () => isPaused.value,\n    (paused) => {\n      if (paused) {\n        video?.pause();\n      } else {\n        lastTimestamp.value = -1;\n        video?.play();\n      }\n    }\n  );\n  Rea.useAnimatedReaction(\n    () => seek.value,\n    (value) => {\n      if (value !== null) {\n        video?.seek(value);\n        currentTime.value = value;\n        seek.value = null;\n      }\n    }\n  );\n  Rea.useAnimatedReaction(\n    () => volume.value,\n    (value) => {\n      video?.setVolume(value);\n    }\n  );\n\n  Rea.useFrameCallback(async (frameInfo: FrameInfo) => {\n    \"worklet\";\n    if (!video) {\n      return;\n    }\n    if (isPaused.value) {\n      return;\n    }\n    const currentTimestamp = frameInfo.timestamp;\n    if (lastTimestamp.value === -1) {\n      lastTimestamp.value = currentTimestamp;\n    }\n    const delta = currentTimestamp - lastTimestamp.value;\n    const isOver = currentTime.value + delta > duration;\n\n    if (isOver && looping.value) {\n      console.log(\"in if seek\");\n      seek.value = 0;\n      currentTime.value = seek.value;\n      lastTimestamp.value = currentTimestamp;\n    }\n    // On Web the framerate is uknown.\n    // This could be optimized by using requestVideoFrameCallback (Chrome only)\n\n    if (\n      (delta > currentFrameDuration * 3 && !isOver) ||\n      Platform.OS === \"web\"\n    ) {\n      //console.log(`当前时间:${currentTime.value},时间间隔:${delta},当前帧持续时间:${currentFrameDuration}`)\n      setFrame(video, currentFrame);\n      currentTime.value += delta;\n      lastTimestamp.value = currentTimestamp;\n    }\n  });\n\n  useEffect(() => {\n    return () => {\n      // TODO: should video simply be a shared value instead?\n      Rea.runOnUI(disposeVideo)(video);\n    };\n  }, [video]);\n\n  return {\n    currentFrame,\n    currentTime,\n    duration,\n    framerate,\n    rotation,\n    size,\n  };\n};\n"],"mappings":"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","ignoreList":[]}
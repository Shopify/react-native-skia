name: Android Emulator Smoke Test

on:
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v5.0.0

      - name: Prepare placeholder workspace
        run: |
          mkdir -p apps/example/android/app/build/outputs/apk/debug
          mkdir -p packages/skia
          touch apps/example/android/app/build/outputs/apk/debug/app-debug.apk

      - name: Start placeholder bundler
        run: |
          nohup sh -c 'sleep 120' > "$RUNNER_TEMP/metro.log" 2>&1 &

      - name: Emulator script smoke test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          profile: Nexus 5X
          force-avd-creation: true
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            cat <<'BASH' > /tmp/run-android-smoke.sh
            #!/usr/bin/env bash
            set -euo pipefail

            ROOT_DIR="$GITHUB_WORKSPACE"
            adb wait-for-device
            until adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; do
              sleep 2
            done

            adb shell getprop ro.build.version.release >/tmp/emulator-version.txt
            cd "$ROOT_DIR/packages/skia"
            cat /tmp/emulator-version.txt
            BASH
            chmod +x /tmp/run-android-smoke.sh
            /tmp/run-android-smoke.sh
